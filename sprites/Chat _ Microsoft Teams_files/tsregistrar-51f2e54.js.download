!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("@skype/tsregistrar",[],e):"object"==typeof exports?exports["@skype/tsregistrar"]=e():t["@skype/tsregistrar"]=e()}(this,function(){return function(t){function e(n){if(r[n])return r[n].exports;var o=r[n]={i:n,l:!1,exports:{}};return t[n].call(o.exports,o,o.exports,e),o.l=!0,o.exports}var r={};return e.m=t,e.c=r,e.i=function(t){return t},e.d=function(t,r,n){e.o(t,r)||Object.defineProperty(t,r,{configurable:!1,enumerable:!0,get:n})},e.n=function(t){var r=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(r,"a",r),r},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=1)}([function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Timespan=e.toJson=e.fetchWithTimeout=void 0,e.fetchWithTimeout=function(t,e){var r,n=new Promise(function(e,n){fetch(t).then(function(t){clearTimeout(r),e(t)}).catch(function(t){clearTimeout(r),n(t)})});if(0!==e){var o=new Promise(function(n,o){r=setTimeout(o,e,new Error("Fetch for '".concat(t.url,"' timed out")))});return Promise.race([n,o])}return n},e.toJson=function(t){try{return JSON.stringify(t)}catch(e){return"Unable to serialize object of type ".concat(typeof t)}};var n=function(){function t(){this.start=Date.now()}return Object.defineProperty(t.prototype,"duration",{get:function(){return Date.now()-this.start},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"startTime",{get:function(){return this.start},enumerable:!1,configurable:!0}),t.prototype.reset=function(){this.start=Date.now()},t}();e.Timespan=n},function(t,e,r){"use strict";var n=this&&this.__extends||function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])})(e,r)};return function(e,r){function n(){this.constructor=e}if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),o=this&&this.__awaiter||function(t,e,r,n){function o(t){return t instanceof r?t:new r(function(e){e(t)})}return new(r||(r=Promise))(function(r,i){function s(t){try{c(n.next(t))}catch(t){i(t)}}function a(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){t.done?r(t.value):o(t.value).then(s,a)}c((n=n.apply(t,e||[])).next())})},i=this&&this.__generator||function(t,e){function r(t){return function(e){return n([t,e])}}function n(r){if(o)throw new TypeError("Generator is already executing.");for(;a&&(a=0,r[0]&&(c=0)),c;)try{if(o=1,i&&(s=2&r[0]?i.return:r[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,r[1])).done)return s;switch(i=0,s&&(r=[2&r[0],s.value]),r[0]){case 0:case 1:s=r;break;case 4:return c.label++,{value:r[1],done:!1};case 5:c.label++,i=r[1],r=[0];continue;case 7:r=c.ops.pop(),c.trys.pop();continue;default:if(s=c.trys,!(s=s.length>0&&s[s.length-1])&&(6===r[0]||2===r[0])){c=0;continue}if(3===r[0]&&(!s||r[1]>s[0]&&r[1]<s[3])){c.label=r[1];break}if(6===r[0]&&c.label<s[1]){c.label=s[1],s=r;break}if(s&&c.label<s[2]){c.label=s[2],c.ops.push(r);break}s[2]&&c.ops.pop(),c.trys.pop();continue}r=e.call(t,c)}catch(t){r=[6,t],i=0}finally{o=s=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}var o,i,s,a,c={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return a={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a};Object.defineProperty(e,"__esModule",{value:!0}),e.createRegistrarClient=e.RegistrarClient=void 0;var s=r(0),a=["skype","aad","cae"],c=function(t){function e(e){var r=t.call(this,e)||this;return r.name="CancelationError",r}return n(e,t),e}(Error),u=function(){function t(e,r,n){this.logger=e,this.maxBackoffInMs=r,this.initialDelay=n,this.backoffCount=0,this.id=++t.idCounter}return t.prototype.delay=function(t){var e=this;if(void 0!==this.timerHandle)throw new Error("Retry sequence logical failure");if(-1===this.backoffCount)return new Promise(function(t,e){e(new c("Cancelled"))});var r=this.calculateNextBackoffMs();return this.backoffCount++,this.logger.info("[RegistrarClient] Backing off ".concat(t," for ").concat(r," milliseconds with ID ").concat(this.id)),new Promise(function(n,o){e.cancelFunc=o,e.timerHandle=setTimeout(function(){e.logger.info("[RegistrarClient] Back off for ".concat(t," with ID ").concat(e.id," complete")),e.timerHandle=void 0,n()},r)})},t.prototype.cancel=function(){void 0!==this.timerHandle&&(this.logger.debug("Resetting back off"),clearTimeout(this.timerHandle),void 0!==this.cancelFunc&&this.cancelFunc(new c("Cancelled"))),this.backoffCount=-1},t.prototype.calculateNextBackoffMs=function(){var t=1+.4*(Math.random()-.5),e=this.initialDelay*Math.pow(2,this.backoffCount)*t;return e=Math.round(e),Math.min(this.maxBackoffInMs,e)},t.idCounter=0,t}(),l=function(){function t(t,e,r){var n;this.logger=t,this.tokenProvider=e,this.options=r,this.DEFAULT_MAX_RETRIES_FOR_GET_TOKEN=15,this.DEFAULT_MAX_BACKOFF_TIME_IN_MS=3e5,this.backoffs={},this.maxBackOffTime=this.options.maxRetryDelayMs>0?this.options.maxRetryDelayMs:this.DEFAULT_MAX_BACKOFF_TIME_IN_MS,this.maxRetriesForGetToken=void 0===r.maxRetriesForGetToken||null===r.maxRetriesForGetToken?this.DEFAULT_MAX_RETRIES_FOR_GET_TOKEN:r.maxRetriesForGetToken,this.proxyUrlRewrite=null!==(n=r.proxyUrlRewrite)&&void 0!==n?n:function(t){return t}}return t.prototype.setTelemetryLogger=function(t){this.eventLogger=t},t.prototype.register=function(t,e){return o(this,void 0,void 0,function(){return i(this,function(r){switch(r.label){case 0:return[4,this.performRegistration(t,e,"pr_set_registration")];case 1:return r.sent(),this.cachedRegistrationParams=[t,e],[2]}})})},t.prototype.unregister=function(){return o(this,void 0,void 0,function(){var t;return i(this,function(e){switch(e.label){case 0:return this.logger.info("[RegistrarClient] sending unregister request"),t=new Request(this.proxyUrlRewrite("".concat(this.options.registrarUrl,"/").concat(this.options.registrationId)),{method:"DELETE",mode:"cors",headers:new Headers({accept:"application/json, text/javascript"})}),[4,this.callRegistrar(t,"pr_delete_registration")];case 1:return e.sent(),[2]}})})},t.prototype.cancelPendingRequests=function(){var t=this;Object.keys(this.backoffs).forEach(function(e){t.backoffs[e].cancel()}),this.backoffs={}},t.prototype.resendRegistration=function(){return o(this,void 0,void 0,function(){return i(this,function(t){switch(t.label){case 0:if(!this.cachedRegistrationParams)throw new Error("Re-registration failed because there is no registration parameters cached");return[4,this.performRegistration(this.cachedRegistrationParams[0],this.cachedRegistrationParams[1],"pr_resend_registration")];case 1:return t.sent(),[2]}})})},t.prototype.performRegistration=function(t,e,r){return o(this,void 0,void 0,function(){var n,o;return i(this,function(i){switch(i.label){case 0:return this.logger.info("[RegistrarClient] Sending register request"),n={clientDescription:t,registrationId:this.options.registrationId,nodeId:"",transports:e},o=new Request(this.proxyUrlRewrite(this.options.registrarUrl),{method:"POST",mode:"cors",headers:new Headers({"content-type":"application/json",accept:"application/json, text/javascript"}),body:(0,s.toJson)(n)}),[4,this.callRegistrar(o,r)];case 1:return i.sent(),[2]}})})},t.prototype.startBackoff=function(){var t=new u(this.logger,this.maxBackOffTime,this.options.initialRetryDelayMs);return this.backoffs[t.id]=t,t},t.prototype.stopBackoff=function(t){t.cancel(),delete this.backoffs[t.id]},t.prototype.getToken=function(t){return o(this,void 0,void 0,function(){var e,r,n,o,s,c,u;return i(this,function(i){switch(i.label){case 0:e=this.startBackoff(),r=0,i.label=1;case 1:return i.trys.push([1,3,,8]),this.logger.info("[RegistrarClient] Asking for a new token"),[4,this.tokenProvider({needFresh:!0,supportedTokenTypes:a,wwwAuthenticateHeader:t})];case 2:return n=i.sent(),this.stopBackoff(e),[2,n];case 3:o=i.sent(),i.label=4;case 4:return i.trys.push([4,6,,7]),r++,s=JSON.stringify(o),r>this.maxRetriesForGetToken?(c="[RegistrarClient] getToken retry limit hit. Will not retry now. Error: ".concat(s),this.logger.error(c),this.stopBackoff(e),[2,Promise.reject(c)]):(this.logger.warn("[RegistrarClient] Retrying for a new token. Retry Count: ".concat(r," Error: ").concat(s)),[4,e.delay("Fetching a new token")]);case 5:return i.sent(),[3,8];case 6:throw u=i.sent(),this.stopBackoff(e),u;case 7:return[3,8];case 8:return[3,1];case 9:return[2]}})})},t.prototype.callRegistrar=function(t,e){var r,n,c;return o(this,void 0,void 0,function(){var o,u,l,f,h,p,d,g,y,w,v,m,k,b,R,T,_;return i(this,function(i){switch(i.label){case 0:return o=this.startBackoff(),[4,this.tokenProvider({needFresh:!1,supportedTokenTypes:a,wwwAuthenticateHeader:void 0})];case 1:u=i.sent(),this.setTokenHeader(t,u),l=new s.Timespan,f=0,i.label=2;case 2:h=void 0,i.label=3;case 3:return i.trys.push([3,8,13,14]),p=t.clone(),[4,(0,s.fetchWithTimeout)(p,this.options.requestTimeoutMs)];case 4:return 401!==(h=i.sent()).status?[3,6]:++f>this.maxRetriesForGetToken?(d="[RegistrarClient] getSkypeToken retry limit hit. Will not retry now. Request '".concat(t.url,"' failed with ").concat(h.status," ").concat(h.statusText),this.logger.error(d),this.stopBackoff(o),[2,Promise.reject(d)]):(this.logger.warn("[RegistrarClient] Retry Count ".concat(f,". Request '").concat(t.url,"' failed with ").concat(h.status," ").concat(h.statusText)),g=null!==(n=null===(r=h.headers)||void 0===r?void 0:r.get("www-authenticate"))&&void 0!==n?n:void 0,y=this.setTokenHeader,w=[t],[4,this.getToken(g)]);case 5:return y.apply(this,w.concat([i.sent()])),[3,20];case 6:if(h.status>=500&&h.status<600)throw new Error("Fetch for '".concat(t.url,"' failed with ").concat(h.status," ").concat(h.statusText));i.label=7;case 7:return[3,14];case 8:v=i.sent(),this.logger.error("[RegistrarClient] Request failed with ".concat(v)),i.label=9;case 9:return i.trys.push([9,11,,12]),[4,o.delay("Registrar call retry")];case 10:return i.sent(),[3,20];case 11:throw m=i.sent(),this.logger.error("[RegistrarClient] Request cancelled"),this.stopBackoff(o),m;case 12:return[3,14];case 13:return this.sendTelemetryEvent(e,t,h,l),[7];case 14:return this.stopBackoff(o),h.ok?[2,h]:[3,15];case 15:k=void 0,i.label=16;case 16:return i.trys.push([16,18,,19]),R=(b=JSON).stringify,[4,h.json()];case 17:return k=R.apply(b,[i.sent()]),[3,19];case 18:return T=i.sent(),k="no details",[3,19];case 19:throw _="Fetch for '".concat(t.url,"' failed with ").concat(h.status," ").concat(h.statusText," (").concat(k,", MS-CV: ").concat(null===(c=h.headers)||void 0===c?void 0:c.get("MS-CV"),")"),this.logger.error("[RegistrarClient] ".concat(_)),new Error(_);case 20:return[3,2];case 21:return[2]}})})},t.prototype.setTokenHeader=function(t,e){switch(e.tokenType.toLowerCase()){case"skype":t.headers.set("X-Skypetoken",e.token);break;case"aad":case"cae":t.headers.set("Authorization","Bearer ".concat(e.token));break;default:throw new Error("unsupported token type: ".concat(e.tokenType))}t.headers.set("X-MS-Migration","True")},t.prototype.sendTelemetryEvent=function(t,e,r,n){if(void 0!==this.eventLogger){var o={name:t,properties:{url:{value:e.url},result_code:{value:void 0!==r?r.status:0},begin_timestamp:{value:n.startTime},elapsed:{value:n.duration}}};this.eventLogger.logEvent(o)}},t}();e.RegistrarClient=l,e.createRegistrarClient=function(t,e,r){return new l(t,e,r)}}])});
//# sourceMappingURL=[[staticsPath]]/hashed/tsregistrar-23bc8b4.js.map